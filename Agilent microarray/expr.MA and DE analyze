###return the expression data of each color from two color array, i think which may be correct but need to valid.
#Gordon Smyth said that we do not need to disassemble the limma data objects.https://www.biostars.org/p/492110/
targets2 <- targetsA2C(target)
eset = exprs.MA(MA.reomoveCTprobe.average) #get the expression from MA. In the guide, I think it will from aCY3, aCy5, bCy3, bCy5...... So it may be arranged as targets2 list? 
colnames(eset) <- rownames(targets2) # If it arranged correctly, this code may be right. But if it doesnt arranged as targets, this is the thing i dont sure.
rownames(eset) <- MA.reomoveCTprobe.average$genes$GeneName #make the rowname to the genenames from the rawdata
eset <- eset[row.names(eset) %in% row.names(Annotationname), ] #filter eset to only mRNA based on filter genes which i do it in the pre-process(excluding some begining with 'chr')

### remove batch effect
batch <- targets2$Batch
eset <- removeBatchEffect(eset, batch)
sampleinfo <- targets2$Target %>% as.data.frame()%>% # make a data.frame for each array with responding group. 
  mutate(rownames(targets2)) %>%
  `colnames<-`(c('group','filenames'))
rownames(sampleinfo) <- sampleinfo$filenames

### check the PCA of sample
PCA <- prcomp(t(eset), scale = FALSE)
percentVar <- round(100*PCA$sdev^2/sum(PCA$sdev^2),1)
sd_ratio <- sqrt(percentVar[2] / percentVar[1])
dataGG <- data.frame(PC1 = PCA$x[,1], PC2 = PCA$x[,2],
                     Model =
                       targets2$Target)
ggplot(dataGG, aes(PC1, PC2)) +
  geom_point(aes(shape = Model)) +
  ggtitle("PCA (cluster experimental groups)") +
  xlab(paste0("PC1, VarExp: ", percentVar[1], "%")) +
  ylab(paste0("PC2, VarExp: ", percentVar[2], "%")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  coord_fixed(ratio = sd_ratio) +
  scale_shape_manual(values = c(1:12)) # this value will depended on the total group number
  
### DEG
### firstly check the PCA of each comtrast, because total PCA may difficult to see the detail of subgroups 
eset_new = eset[, targets2$Target %in% c('wt.C7','wt.SC7','wt.Control') ] # choose the target col which filename cooresponding to group in target
sampleinfonew <- sampleinfo[sampleinfo$group%in%c('wt.C7','wt.SC7','wt.Control'),] 
pca.info <- fast.prcomp(eset_new)
pcadata <- data.frame(sample = rownames(pca.info$rotation),Type = c(rep('wt.C7plus6',6),rep('wt.SC7plus6',6),rep('wt.Control',12)),pca.info$rotation)
ggscatter(pcadata,x = 'PC1',y = 'PC2',
          color = 'Type',
          ellipse = TRUE, #make a sepration between two group or add # ellipse.type = 'convex',
          size =4, 
          main = 'PCA plot') 
boxplot(eset_new) # check the expr normal or not

### make contrast for DEG
u <- unique(targets2$Target)
f <- factor(targets2$Target, levels=u)
design <- model.matrix(~0+f) #make the design with each color of total sample
colnames(design) <- u
rownames(design) <- rownames(targets2)
contrastdesign <- design[ ,c('wt.C7','wt.SC7','wt.Control')] 
contrastdesign <-  contrastdesign[sampleinfo$group%in%c("wt.SC7plus6","wt.C7plus6","wt.Control"),] #make a design for the eset_new
cont.matrix <- makeContrasts(wt.C7vswt.SC7=wt.C7-wt.SC7,levels=design)

fit2 <- lmFit(eset_new, contrastdesign) %>% # Fit linear model
  contrasts.fit( cont.matrix ) %>% # compute estimated coefficients and standard errors for a given set of contrasts
  eBayes # compute moderated t-statistics, moderated F-statistic, and log-odds of differential expression
results <- decideTests(fit2)
vennDiagram(results) # do a venn for the DE in three contrast

degs_temp <- topTable(fit2,coef=1, adjust="BH", n = Inf)%>%na.omit # get the detail of different DE
logFC_cut = with(degs_temp, mean(abs(logFC))+2*sd(abs(logFC))) # get a 95%CI for logFC
degs_temp = degs_temp %>%
  mutate( DEG = factor( ifelse( abs(degs_temp$logFC) > 1 & degs_temp$adj.P.Val < 0.05,
                                ifelse(degs_temp$logFC > 0, 'up','down'),
                                'ns' ), 
                        levels = c("up", "ns", "down" ), ordered = F ) )%>%
  mutate( row = rownames(degs_temp)) # for the volcano plot
summary(degs_temp)
head(degs_temp)
table(degs_temp$DEG) #to see the number of up and down genes


### volcano plot 
#first choice
p1 <- gradual_volcano(degs_temp, x = "logFC", y = "P.Value", # because adjP plot may unsatisfied, so i plot it with P-value.
                      fills = brewer.pal(5, "RdYlBu"),
                      colors = brewer.pal(8, "RdYlBu"),
                      x_lab = 'logFC',
                      y_lab = '-log10(P.Value)',
                      legend_title = '-log10',
                      pointSizeRange = c(0.5, 4),
                      label = "row", label_number = 10, output = FALSE) # with 10 genes with names
p1 
save(degs_temp, file = paste('wt.C7plus6-wt.SC7plus6','.Rdata',sep = ""))

degs_temp$label <- c(rownames(degs_temp)[1:10],rep(NA,(nrow(degs_temp)-10))) #get the label need to clear
p1 <- ggplot(degs_temp,aes(logFC, -log10(adj.P.Val)))+
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "#999999")+
  geom_vline(xintercept = c(-1.2,1.2), linetype = "dashed", color = "#999999")+
  geom_point(aes(size=-log10(adj.P.Val), color= -log10(adj.P.Val)))+
  scale_color_gradientn(values = seq(0,1,0.2),
                        colors = c("#39489f","#39bbec","#f9ed36","#f38466","#b81f25"))+    # 指定颜色渐变模式：
  scale_size_continuous(range = c(1,3))+    # 指定散点大小渐变模式：
  theme_bw()+
  theme(panel.grid = element_blank(),
        legend.position = c(0.01,0.7),
        legend.justification = c(0,1)    # 调整主题和图例位置：
  )+
  guides(col = guide_colourbar(title = "-Log10_q-value"),
         size = "none")+    # 设置部分图例不显示：
  geom_text(aes(label=label, color = -log10(adj.P.Val)), size = 3, vjust = 1.5, hjust=1)+    # 添加标签：
  xlab("Log2FC")+
  ylab("-Log10(FDR q-value)")    # 修改坐标轴：

###heat map for degs
chs_x = degs_temp %>%
  slice_max( abs(logFC), n = 50 ) 
heat_matrix <- eset_new [row.names(eset_new) %in% row.names(chs_x), ] 
legend_col = data.frame(row.names = colnames(eset_new),
  Group= sampleinfonew$group)  # set the label of group
rownames(legend_col) <- colnames(heat_matrix)
heat1 <- pheatmap(heat_matrix, scale="row", name = 'Expression level',
                  cellwidth = 10,cellheight = 5, # set the high and wide of box
                  border="white",
                  annotation_col = legend_col,
                  annotation_colors = list(Group=(c(wt.C7="#1B9E77",wt.Control="#D95F02"))),
                  cluster_rows = F,# del the cluster of genes
                  cluster_cols = TRUE,
                  show_rownames = F, #delete the row and col id
                  show_colnames = F, 
                  clustering_distance_rows = "minkowski", # set the class of cluster
                  color = c(colorRampPalette(colors = c("dodgerblue4","white"))(length(brk)/2),
                            colorRampPalette(colors = c("white","brown"))(length(brk)/2)),
                  #cutree_cols = 3, #划分列
                  #cutree_rows =5, #划分行
                  #cluster_cols = TRUE,treeheight_col = 20, #按照列（样本名）划分区域
                  #cluster_rows = T,treeheight_row = 20,按照行（基因名）划分区域
                  fontsize_row = 12, # set the size of font
                  fontsize_col = 16)
heat1
p2 = as.ggplot(heat1)+
  ggtitle('Top 500 DEGs')+  
  theme(
    plot.title = element_text(hjust = 0.4),
    plot.background = element_rect(fill = "transparent",colour = NA)
  )
p2
